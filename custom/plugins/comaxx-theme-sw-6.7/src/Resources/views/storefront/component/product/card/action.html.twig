{% sw_extends '@Storefront/storefront/component/product/card/action.html.twig' %}

{% set comaxxShowBuyIcon = theme_config('comaxx-show-buy-button-icon') %}
{% set comaxxBuyIconCode = theme_config('comaxx-buy-button-icon-code') %}
{% set comaxxDetailIconCode = theme_config('comaxx-detail-button-icon-code') %}
{% set comaxxShowQuantity = theme_config('comaxx-show-quantity-selector') %}

{% set showQuantitySelect = comaxxShowQuantity == '1' and (not product.states is defined or DOWNLOAD_STATE not in product.states or (DOWNLOAD_STATE in product.states and product.maxPurchase != 1)) %}
{% set buyable = product.available and product.childCount <= 0 and product.calculatedMaxPurchase > 0 %}

{# Check of product alleen kleurvarianten heeft #}
{% set onlyColor = product.extensions.filteredVariants is defined and product.extensions.filteredVariants.onlyColor %}

{% block component_product_box_action_inner %}
    {% set id = product.id %}
    <div class="product-action" data-has-only-color="{{ onlyColor ? '1' : '0' }}">
        {% set isAvailable = not product.isCloseout or (product.stock >= product.minPurchase) %}
        {% set displayFrom = product.calculatedPrices.count > 1 %}
        {% set displayBuyButton = isAvailable and not displayFrom and product.childCount <= 0 %}
        {% set displayBuyOrOnlyColor = displayBuyButton or onlyColor %}

        {# Nieuw: check voor producten die buyable zijn en géén varianten hebben #}
        {% set showDetailButton = onlyColor and not buyable %}

        {% if displayBuyOrOnlyColor and config('core.listing.allowBuyInListing') %}
            {% block component_product_box_action_buy %}
                <form action="{{ path('frontend.checkout.line-item.add') }}"
                      method="post"
                      class="buy-widget"
                      data-add-to-cart="true"
                      data-only-color="{{ onlyColor ? '1' : '0' }}">
                    {% block component_product_box_action_form %}
                        {% block component_product_box_action_buy_redirect_input %}
                            <input type="hidden" name="redirectTo" value="frontend.detail.page">
                            <input type="hidden" name="redirectParameters" data-redirect-parameters="true"
                                   value="{{ {productId: id}|json_encode }}">
                        {% endblock %}

                        {% block component_product_box_action_buy_info %}
                            <input type="hidden" name="lineItems[{{ id }}][id]" value="{{ id }}">
                            <input type="hidden" name="lineItems[{{ id }}][referencedId]" value="{{ id }}">
                            <input type="hidden" name="lineItems[{{ id }}][type]" value="product">
                            <input type="hidden" name="lineItems[{{ id }}][stackable]" value="1">
                            <input type="hidden" name="lineItems[{{ id }}][removable]" value="1">
                            <input type="hidden" name="lineItems[{{ id }}][quantity]" value="{{ product.minPurchase }}">
                        {% endblock %}

                        {% block component_product_box_action_buy_meta %}
                            <input type="hidden" name="product-name" value="{{ product.translated.name }}">
                        {% endblock %}

                        <div class="d-grid{% if showQuantitySelect %} product-action-quantity{% endif %}">
                            {% block component_product_box_action_buy_button_quantity %}
                                {% if showQuantitySelect %}
                                    <div class="quantity-wrapper">
                                        <select name="lineItems[{{ id }}][quantity]" id="quantity-{{ id }}" class="form-control form-select quantity-select">
                                            {% for i in 1..product.availableStock %}
                                                <option value="{{ i }}" {% if i == product.minPurchase %}selected{% endif %}>
                                                    {{ i }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                {% else %}
                                    <input type="hidden" name="lineItems[{{ id }}][quantity]" value="{{ product.minPurchase }}">
                                {% endif %}
                            {% endblock %}

                            {# Buttons #}
                            {% set buyStyle = onlyColor ? 'display:none;' : '' %}
                            {% set detailStyle = showDetailButton ? 'display:block;' : 'display:none;' %}

                            {% block component_product_box_action_buy_button_detail %}
                                <button class="btn btn-buy{% if comaxxShowBuyIcon %} has-icon{% endif %}" style="{{ buyStyle }}"
                                        title="{{ 'listing.boxAddProduct'|trans|striptags }}">
                                    {% if comaxxShowBuyIcon %}
                                        {% block component_product_box_action_buy_button_icon %}
                                            <span class="material-symbols-{{ comaxxIconStyleClass }} btn-buy-icon">
                                                {{ comaxxBuyIconCode | default('shopping_cart') }}
                                            </span>
                                        {% endblock %}
                                    {% endif %}
                                    {% block page_product_detail_product_buy_button_label %}
                                        {% if comaxxShowBuyIcon != '2' %}
                                            {{ 'listing.boxAddProduct'|trans|sw_sanitize }}
                                        {% endif %}
                                    {% endblock %}
                                </button>

                                <a href="{{ seoUrl('frontend.detail.page', {productId: id}) }}"
                                   class="btn btn-light btn-detail{% if comaxxShowBuyIcon %} has-icon{% endif %}"
                                   style="{{ detailStyle }}">
                                    {% if comaxxShowBuyIcon %}
                                        {% block component_product_box_action_detail_button_icon %}
                                            <span class="material-symbols-{{ comaxxIconStyleClass }} btn-buy-icon">
                                                {{ comaxxDetailIconCode | default('settings') }}
                                            </span>
                                        {% endblock %}
                                    {% endif %}
                                    {% block component_product_box_action_detail_label %}
                                        {% if comaxxShowBuyIcon != '2' %}
                                            {{ 'listing.boxProductDetails'|trans|sw_sanitize }}
                                        {% endif %}
                                    {% endblock %}
                                </a>
                            {% endblock %}
                        </div>
                    {% endblock %}
                </form>
            {% endblock %}
        {% else %}
            {# fallback: alleen detail-knop tonen #}
            {% block component_product_box_action_detail %}
                <div class="d-grid">
                    <a href="{{ seoUrl('frontend.detail.page', {productId: id}) }}"
                       class="btn btn-light btn-detail{% if comaxxShowBuyIcon %} has-icon{% endif %}">
                        {% if comaxxShowBuyIcon %}
                            {% block component_product_box_action_detail_button_icon_fallback %}
                                <span class="material-symbols-{{ comaxxIconStyleClass }} btn-buy-icon">
                                    {{ comaxxDetailIconCode | default('settings') }}
                                </span>
                            {% endblock %}
                        {% endif %}
                        {% block component_product_box_action_detail_label_fallback %}
                            {% if comaxxShowBuyIcon != '2' %}
                                {{ 'listing.boxProductDetails'|trans|sw_sanitize }}
                            {% endif %}
                        {% endblock %}
                    </a>
                </div>
            {% endblock %}
        {% endif %}
    </div>
{% endblock %}